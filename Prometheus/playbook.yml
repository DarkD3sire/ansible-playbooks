---
- hosts: all
  become: true
  vars_files:
    - vars/default.yml
  vars:
    proxy_env:
      http_proxy: http://10.199.4.240:3128/
      https_proxy: http://10.199.4.240:3128/
  
  tasks:
    - name: Download and unpack latest Prometheus
      unarchive:
        src: https://github.com/prometheus/node_exporter/releases/download/v1.3.1/node_exporter-1.3.1.linux-amd64.tar.gz
        dest: "/home/iitbdrf"
        remote_src: yes
      tags: [ node_explorer ]

    - name: Copy the node_exporter service file
      template:
        src: "files/node_exporter.service.j2"
        dest: "/etc/systemd/system/node_exporter.service"
      tags: [ node_explorer ]    

    - name: Start and enable node_explorer service, in all cases, also issue daemon-reload to pick up config changes
      ansible.builtin.systemd:
        state: started
        daemon_reload: yes
        name: node_exporter
        enabled: yes

- hosts: localhost
  become: true
  vars_files:
    - vars/default.yml

  tasks:
    - name: Add the new server IP to prometheus
      lineinfile:
        dest: /home/prometheus/prometheus/prometheus.yml
        line: "      - targets: [ '192.168.184.129:9100' ]"

    - name: Restart prometheus
      ansible.builtin.systemd:
        state: restarted
        name: prometheus